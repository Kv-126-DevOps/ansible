---
- name: 'Install epel repositories'
   shell: amazon-linux-extras install epel -y
   become: true

 - name: 'Enable epel repositories'
   shell: yum-config-manager --enable epel
   become: true

 - name: 'Disable repository priority protections'
   template:
     src: priorities.conf.j2
     dest: /etc/yum/pluginconf.d/priorities.conf
     owner: root
     group: root
     mode: 0644
     backup: true

 - name: 'Retrieve the installed packages'
   package_facts:

 - name: 'Get list of installed packages'
   set_fact:
      installed_packages: "{{ ansible_facts.packages.keys() }}"

 - name: 'Find missing packages'
   set_fact:
     missing_packages: "{{ required_pkgs | difference (installed_packages) }}"

 - name: 'Install missing packages'
   package:
     name: "{{ missing_packages }}"
     state: present
     update_cache: true
